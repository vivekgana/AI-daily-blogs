name: Run Tests

on:
  push:
    branches: [ main, develop, 'feature/**', 'fix/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger
  schedule:
    - cron: '0 12 * * *'  # Daily at 12 PM UTC

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-html

    - name: Run unit tests
      run: |
        pytest tests/unit/ -v \
          --cov=src \
          --cov-report=term-missing \
          --cov-report=html \
          --html=unit-test-report.html \
          --self-contained-html

    - name: Upload unit test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: unit-test-results
        path: |
          unit-test-report.html
          htmlcov/

    - name: Comment test results on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const testResults = '‚úÖ Unit tests completed. Check artifacts for detailed results.';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## Unit Test Results\n\n${testResults}`
          });

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests  # Run after unit tests pass

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-html

    - name: Configure Kaggle credentials
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_PASSWORD }}
      run: |
        mkdir -p ~/.kaggle
        echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_PASSWORD }}"}' > ~/.kaggle/kaggle.json
        chmod 600 ~/.kaggle/kaggle.json

    - name: Run integration tests
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_PASSWORD }}
        GITHUB_TOKEN: ${{ secrets.MY_GITHUB_ACTION }}
      run: |
        pytest tests/integration/ -v \
          --html=integration-test-report.html \
          --self-contained-html \
          -x  # Stop on first failure

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results
        path: integration-test-report.html

    - name: Create test summary
      if: always()
      run: |
        echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Kaggle API: Tested" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ GitHub API: Tested" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Research/arXiv: Tested" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ End-to-End workflows: Tested" >> $GITHUB_STEP_SUMMARY

    - name: Comment integration results on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const testResults = '‚úÖ Integration tests completed. All API connections verified.';
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## Integration Test Results\n\n${testResults}\n\nCheck artifacts for detailed reports.`
          });

  test-credentials:
    name: Verify Credentials
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-dotenv google-generativeai kaggle PyGithub

    - name: Create credentials test script
      run: |
        cat > test_github_secrets.py << 'EOF'
        import os
        import sys

        print("\n" + "=" * 70)
        print("CREDENTIAL VERIFICATION (GitHub Secrets)")
        print("=" * 70)

        checks = {
            'GEMINI_API_KEY': os.getenv('GEMINI_API_KEY'),
            'KAGGLE_USERNAME': os.getenv('KAGGLE_USERNAME'),
            'KAGGLE_KEY': os.getenv('KAGGLE_KEY'),
            'GITHUB_TOKEN': os.getenv('GITHUB_TOKEN'),
        }

        passed = 0
        failed = 0

        for name, value in checks.items():
            if value and len(value) > 5:
                print(f"‚úÖ {name}: Set (length: {len(value)})")
                passed += 1
            else:
                print(f"‚ùå {name}: Not set or invalid")
                failed += 1

        print("\n" + "=" * 70)
        print(f"Result: {passed}/{len(checks)} credentials configured")

        if failed > 0:
            print(f"\n‚ùå {failed} credential(s) missing!")
            print("Configure them in: Settings ‚Üí Secrets and variables ‚Üí Actions")
            sys.exit(1)
        else:
            print("\n‚úÖ All credentials configured correctly!")
            sys.exit(0)
        EOF

    - name: Verify credentials are set
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_PASSWORD }}
        GITHUB_TOKEN: ${{ secrets.MY_GITHUB_ACTION }}
      run: python test_github_secrets.py

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, test-credentials]
    if: failure()

    steps:
    - name: Create issue on test failure
      uses: actions/github-script@v7
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Test Failure: ${context.workflow} - ${context.ref}`,
            body: `## Test Failure Alert

            **Workflow:** ${context.workflow}
            **Branch:** ${context.ref}
            **Run:** [${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            One or more test suites failed. Please review the workflow logs.

            ### Next Steps
            1. Check the workflow logs for details
            2. Review test artifacts for detailed reports
            3. Fix failing tests
            4. Re-run the workflow

            ---
            ü§ñ Auto-generated by GitHub Actions`,
            labels: ['test-failure', 'automation']
          });
          console.log(`Created issue #${issue.data.number}`);
